## 어떤 인스턴스를 사용할까?

### 기준

1. 기존의 t3a.medium 인스턴스보다 저렴해야 한다.
2. CPU는 2개 이상
3. 버스트 기능을 지원해야 한다. (성능 테스트를 위해)

### 선택

위의 조건을 모두 부합하는 t3a.small 인스턴스로 다운그레이드를 진행했다.


## Jenkins가 멈췄다...

![[Pasted image 20240308200455.png]]

2분 26초 대에서 더 이상 진행되지 않는다.
SSH로 접속한 서버도 완전히 멈춰버렸다.

인스턴스 재시작을 해도 소용이 없다.
느려터진 서버 콘솔로 Jenkins 컨테이너를 재시작해서야 이 녀석을 멈출 수 있었다.

뭐가 문제였을까?

### CPU 사용률

![[Pasted image 20240308213905.png|400]]

Jenkins 빌드를 실행하고 종료할 때까지의 CPU 사용량이다.
peek 지점이 55%인 것을 미루어 보아, CPU 사용률이 이 현상의 문제라고 할 수는 없을 것 같다.

CPU가 문제가 없으니, **메모리 부족으로 인한 hang 현상이 의심되었다.**
ref) https://www.mantech.co.kr/hang-solutions/


### 메모리 사용량

![[Pasted image 20240308205650.png]]

**total**: 전체 메모리 크기
**used**: 사용 중인 메모리 크기
**free**: 시스템에서 사용 가능한 잔여 메모리 크기
**buff/cache**: 캐시 영역으로 사용하는 메모리 크기
**available**: swapping 없이 애플리케이션을 실행 가능한 가용 메모리 크기
ref) https://brunch.co.kr/@dreaminz/2

현재 약 40% 정도의 메모리를 사용하고 있다.


**빌드가 멈추는 시점**인 2분쯤 다시 메모리 사용량을 확인해보았다.

![[Pasted image 20240308212713.png]]

약 98%의 메모리를 사용하고 있었다.
아마 계속 진행했다면, 시스템이 엄청나게 느려지는 현상을 다시 경험할 수 있었을 것이다...

이로써 **메모리 부족이 해당 문제의 원인임을 파악**할 수 있었다.


### 스왑메모리 지정을 통한 해결 시도

인스턴스의 메모리 크기는 2GB... 그마저도 Jenkins 컨테이너가 40%를 점유하고 있다.

메모리가 한정적인 경우, **추가적으로 Disk에 Swap 영역을 지정**하여 이를 **가상의 메모리처럼 사용**할 수 있다.
이를 통해 메모리 부족 현상을 해결해보자.

ref1) [RAM 용량에 따른 적정 스왑메모리 용량](https://help.ubuntu.com/community/SwapFaq#How_much_swap_do_I_need.3F)
ref2) [스왑 파일을 사용하여 Amazon EC2 인스턴스에서 스왑 공간으로 사용할 메모리를 할당하는 방법은 무엇입니까?](https://repost.aws/ko/knowledge-center/ec2-memory-swap-file)

위의 레퍼런스를 참고하여 Swap 영역의 크기를 4GB로 잡았다.

### 결과

![[Pasted image 20240309025533.png]]

해냈구나, 젠킨스!
#### CPU 사용률

![[Pasted image 20240308215927.png|400]]

엄청난 수치다... 왜 이렇게 CPU가 열일했을까?
아무래도 사용 가능한 메모리 양이 적기 때문에 Swap-in/out이 빈번하게 일어났나보다.
- **페이지 폴트가 많이 발생 ➡️ Swap-in/out 많이 발생(Disk I/O) ➡️ CPU 사용률 증가**

이는 빌드 속도에도 충분히 영향이 있었을 것이라고 예상된다.
또한, 자동배포 하나에 이렇게 많은 CPU 자원을 사용했다는 것이 조금 아쉽긴 하다.
#### 메모리 사용량

**빌드 시작 전**
![[Pasted image 20240309030433.png]]

**빌드 시작 2분 경과 후**
![[Pasted image 20240309030459.png]]

**빌드 시작 2분 경화 후 docker stats**
![[Pasted image 20240309034951.png]]

메모리를 점유하던 Jenkins 컨테이너의 많은 부분이 swap-out 되었음을 알 수 있다.
- 빌드 시간이 4분 25초 ➡️ 5분 14초로 늘어났다.

Swap 영역을 활용하여 부족한 메모리를 잘 보완함으로써 빌드를 무사히 마칠 수 있었다.


## 이대로 괜찮은가?

```bash
// Docker 컨테이너 리소스 모니터링
docker stats
```

![[Pasted image 20240309030803.png]]



