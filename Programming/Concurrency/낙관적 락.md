> Pessimistic Lock

## 낙관적 락이란?

> 트랜잭션이 충돌하지 않는다고 가정, commit할 때 동시성 이슈가 발생하면 그 때 처리한다.

낙관적 락은 데이터베이스의 트랜잭션 락 기능을 사용하지 않고, JPA가 제공하는 **버전 관리 기능**을 사용한다.
- 엔티티에 버전 관리용 필드를 추가해주어야 한다.

버전 필드는 엔티티를 **수정할 때마다 버전이 증가**한다.
또한, 엔티티를 수정할 때 **조회시점의 버전과 수정시점의 버전이 다르면 예외가 발생**한다.
- `UPDATE`문의 `WHERE` 절에 조회 시점의 버전과 수정 시점의 버전이 일치한지 확인한다.
- 만약 다른 트랜잭션이 수정해서 버전 정보가 바뀐다면, 수정할 대상이 사라진다.

## 낙관적 락의 특징

- 엔티티가 아닌 스칼라 값(엔티티의 필드들)을 직접 조회하면, 영속성 컨텍스트의 관리를 받지 못하므로 Repeatable Read가 불가하다.
- commit 시점에 충돌을 알 수 있다. (`WHERE` 절에서 버전 일치를 확인하기 때문)
- 버전을 사용한다.
- 데이터베이스의 트랜잭션 락을 사용하지 않고, JPA의 1차 캐시를 사용한다. (성능적으로 우수할 것 같다!)
- 요청부터 종료까지 레코드를 잠그는 비관적 락보다 성능이 좋다.


## Ref

[트랜잭션과 락 - 3. 낙관적 락과 비관적 락](https://velog.io/@on5949/JPA-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EA%B3%BC-%EB%9D%BD-3.-%EB%82%99%EA%B4%80%EC%A0%81-%EB%9D%BD%EA%B3%BC-%EB%B9%84%EA%B4%80%EC%A0%81-%EB%9D%BD)