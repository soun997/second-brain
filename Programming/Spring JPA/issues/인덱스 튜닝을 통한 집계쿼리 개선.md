## 😄글의 주제

현재 개발 중인 [사이드 프로젝트](https://github.com/Vegan-Life/VeganLife-Backend)에는 
사용자가 작성한 식단 기록을 바탕으로 **"특정 기간 동안 섭취한 영양성분을 집계"** 하는 기능이 있다.

### 개선하고자 하는 이유



### 해결방법

두 가지의 해결방법을 고안해보았다.

#### 인덱스를 적용

#### 캐시메모리를 도입


#### 결론

where절 동등연산, 범위연산을 기반으로 해당 인덱스를 생성했다.

원하는 날짜 범위의 데이터를 **빠르게 조회**할 것이라고 기대하였고, 이를 확인해보고 싶었다.


## 🗄테스트 데이터

### 데이터의 형태

- 사용자는 하루에 3개의 식단 기록을 작성한다.
- 사용자는 1년 중 150일 동안 식단을 기록한다.
- 사용자는 3년 동안 식단을 기록한다.

➡️ 사용자는 총 **1350개의 데이터**를 가지고 있다.

### 실행하려고 하는 쿼리

```sql
select ml.meal_type, sum(m.calorie)  
from meal_log ml join meal m on ml.meal_log_id = m.meal_log_id  
and ml.member_id = 50  
and ml.created_at between '2024-01-01 00:00:00' and '2024-12-31 11:59:59'  
group by ml.meal_type;
```

- 사용자가 연간 섭취한 영양성분을 집계

➡️ 위 쿼리는 **450개의 데이터**를 집계하게 된다.


## 🤔실행계획 비교

### 인덱스 적용 전

![[Pasted image 20240320011635.png]]
![[Pasted image 20240320011802.png]]
(순서대로 드라이빙 - 드리븐 테이블이다)
#### 실행계획 분석

`type`(레코드를 읽는 방식)
- `ref`: FK를 이용한 동등 비교 검색을 통해 레코드를 읽었다.
`rows`
- 총 1350개 행을 읽었다.

### 인덱스 적용 후

![[Pasted image 20240317202404.png]]
![[Pasted image 20240317202427.png]]
(순서대로 드라이빙 - 드리븐 테이블이다)
#### 실행계획 분석

`type`(레코드를 읽는 방식)
- `range`: 인덱스를 사용하여 특정 범위의 값(`BETWEEN`)에 해당하는 레코드를 읽었다.
`rows`
- 총 450개 행을 읽었다.

### 결과

인덱스를 적용하기 전에는 해당 사용자가 가지고 있는 전체 레코드를 모두 조회했다.
인덱스를 적용한 후에는 조회하고자 하는 해당 연도의 레코드만을 조회했다.
그 결과, **조회하는 레코드의 수를 3배 줄일 수 있었다.**


## ❓왜 이렇게 동작했을까?

2023년도에 사용자가 섭취한 영양성분을 집계한다고 가정하자.

![[Pasted image 20240320021242.png]]
(빼먹었는데, 인덱스 테이블의 각 레코드에는 테이블의 레코드를 가리키는 pointer도 저장되어 있다!)

인덱스를 생성하지 않았다면 FK인 사용자 ID(`member_id`)를 검색 조건으로 사용하게 된다.
즉, **사용자 ID가 `WHERE` 조건과 일치하는 모든 레코드를 조회**한 후, 2023년도에 기록한 것인지 확인해야 한다.

인덱스를 생성했다면 사용자 ID와 기록 날짜(`created_at`)을 검색 조건으로 사용하게 된다.
인덱스 테이블에 **기록 날짜가 존재**하므로 레코드를 조회하기 전, **2023년도에 기록한 것인지 먼저 확인**할 수 있다.
그러므로 불필요한 조회 없이 원하는 데이터만을 조회할 수 있다.


## ✅결론

### 정리

- **인덱스 튜닝**을 통해 특정 기간의 데이터를 집계하는 쿼리를 최적화했다.
- 그 결과, 조회하는 레코드의 개수가 **3배 감소**하였다.

### 회고

- 테스트 데이터의 수가 많지 않았기 때문에 성능적으로 유의미한 차이가 없었다.
- 테스트 데이터의 개수가 더 많았다면 큰 차이가 있음을 보일 수 있을 것 같다!


## Ref

[[MySQL] 실행계획2 (EXPLAIN)](https://velog.io/@ddongh1122/MySQL-%EC%8B%A4%ED%96%89%EA%B3%84%ED%9A%8D2-EXPLAIN)